<%#-- copyright
OpenProject Costs Plugin

Copyright (C) 2009 - 2014 the OpenProject Foundation (OPF)

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
version 3.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

++#%>

<%= form_tag({}) do -%>

<div class="generic-table--container">
  <div class="generic-table--results-container">
    <table interactive-table class="generic-table" id="material_budget_items">
      <colgroup>
        <col highlight-col>
        <col highlight-col>
        <col highlight-col>
        <col highlight-col>
        <col highlight-col>
        <col highlight-col>
      </colgroup>
      <thead>
        <tr>
          <%= sort_header_tag("id", :caption => '#', :default_order => 'desc') %>
          <%= sort_header_tag("subject", :caption => CostObject.human_attribute_name(:subject)) %>
          <th>
            <div class="generic-table--sort-header-outer">
              <div class="generic-table--sort-header">
                <span>
                  Gautas
                </span>
              </div>
            </div>
          </th>
          <th>
            <div class="generic-table--sort-header-outer">
              <div class="generic-table--sort-header">
                <span>
                  <%= CostObject.human_attribute_name(:spent) %>
                </span>
              </div>
            </div>
          </th>
          <th>
            <div class="generic-table--sort-header-outer">
              <div class="generic-table--sort-header">
                <span>
                  Likęs
                </span>
              </div>
            </div>
          </th>
          <th>
            <div class="generic-table--sort-header-outer">
              <div class="generic-table--sort-header">
                <span>
                  <%= CostObject.human_attribute_name(:budget) %>
                </span>
              </div>
            </div>
          </th>
          <th>
            <div class="generic-table--sort-header-outer">
              <div class="generic-table--sort-header">
                <span>
                    Įgyvendintas
                </span>
              </div>
            </div>
          </th>
          <th>
            <div class="generic-table--sort-header-outer">
              <div class="generic-table--sort-header">
                <span>
                  <%= CostObject.human_attribute_name(:available) %>
                </span>
              </div>
            </div>
          </th>
          <th>
            <div class="generic-table--sort-header-outer">
              <div class="generic-table--sort-header">
                <span>
                  Balansas
                </span>
              </div>
            </div>
          </th>
          <th>
            <div class="generic-table--sort-header-outer">
              <div class="generic-table--sort-header">
                <span>
                  Procentais
                </span>
              </div>
            </div>
          <th>
            <div class="generic-table--sort-header-outer">
              <div class="generic-table--sort-header">
                <span>
                  Dalis nuo viso biudžeto
                </span>
              </div>
            </div>
          </th>
          <th>
            <div class="generic-table--sort-header-outer">
              <div class="generic-table--sort-header">
                <span>
                  <%= CostObject.human_attribute_name(:budget_ratio) %>
                </span>
              </div>
            </div>
          </th>
        </tr>
      </thead>
      <tbody>
        <%
          total_budget = BigDecimal.new("0")
          total_material_budget = BigDecimal.new("0")
          total_spent_material_budget = BigDecimal.new("0")
          total_planned_budget = BigDecimal.new("0")
          total_spent_planned_budget = BigDecimal.new("0")
          total_balance = BigDecimal.new("0")
          material_budget = BigDecimal.new("0")
          spent_material_budget = BigDecimal.new("0")
          material_budget_balance = BigDecimal.new("0")
          planned_budget = BigDecimal.new("0")
          spent_planned_budget = BigDecimal.new("0")
          plannet_budget_balance = BigDecimal.new("0")
          balance = BigDecimal.new("0")
        %>
        <% cost_objects.each do |cost_object| %>
          <%  if cost_object.got_overall_material_budget > 0 %>
            <tr id="cost_object-<%= cost_object.id %>" class="<%= cost_object.css_classes %>">
            <%
                total_budget += cost_object.got_overall_material_budget
            %>
            <td><%= link_to cost_object.id, cost_object_path(cost_object.id) %></td>
            <%= content_tag(:td, link_to(h(cost_object.subject), cost_object_path(cost_object.id)), :class => 'subject') %>

            <%= content_tag(:td, number_to_currency(cost_object.got_overall_material_budget, unit: "", :precision => 2), :class => 'currency') %>
            <td>-</td> 
            <td>-</td> 
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
          </tr>
          <% end %>
        <% end %>
        <% cost_objects.each do |cost_object| %>
          <% if cost_object.got_overall_material_budget <= 0 %>
            <tr id="cost_object-<%= cost_object.id %>" class="<%= cost_object.css_classes %>">
              <%
                material_budget = cost_object.got_material_subbudget
                spent_material_budget = cost_object.spent_material_subbudget
                material_budget_balance = material_budget - spent_material_budget
                planned_budget = cost_object.planned_material_subbudget
                spent_planned_budget = cost_object.spent_planned_material_subbudget
                plannet_budget_balance = planned_budget - spent_planned_budget
                balance = material_budget - spent_planned_budget

                total_material_budget += material_budget
                total_spent_material_budget += spent_material_budget
                total_planned_budget += planned_budget
                total_spent_planned_budget += spent_planned_budget
                total_balance += balance
              %>
              <td><%= link_to cost_object.id, cost_object_path(cost_object.id) %></td>
              <%= content_tag(:td, link_to(h(cost_object.subject), cost_object_path(cost_object.id)), :class => 'subject') %>
              <%= content_tag(:td, number_to_currency(material_budget, unit: "", :precision => 2)) %>
              <%= content_tag(:td, number_to_currency(spent_material_budget, unit: "", :precision => 2)) %>
              <%= content_tag(:td, number_to_currency(material_budget_balance, unit: "", :precision => 2), bgcolor: (material_budget-spent_material_budget)!=0 ? "orange" : nil) %>
              <%= content_tag(:td, number_to_currency(planned_budget, unit: "", :precision => 2)) %>
              <%= content_tag(:td, number_to_currency(spent_planned_budget, unit: "", :precision => 2)) %>
              <%= content_tag(:td, number_to_currency(plannet_budget_balance, unit: "", :precision => 2), bgcolor: (material_budget-spent_material_budget)<0 ? "orange" : nil) %>
              <%= content_tag(:td, number_to_currency(balance, unit: "", :precision => 2)) %>
              <%= content_tag(:td, number_with_precision(balance/material_budget * 100, :precision => 2) + '%', bgcolor: balance/material_budget < 0.1 ? "orange" : nil) %>
              <%= content_tag(:td, number_with_precision(material_budget/total_budget * 100, :precision => 2) + '%') %>
              <%= content_tag(:td, extended_progress_bar(spent_material_budget/material_budget*100, :legend => "#{number_with_precision(spent_material_budget/material_budget*100, :precision => 2)}")) %>
            </tr>
          <% end %>
        <% end %>
        <% if cost_objects.length > 0 %>
        <tr>
          <td />
          <td> Suma </td>
          <td class="currency" <% if (total_material_budget-total_budget).abs > 0.005 %>bgcolor="orange"<% end %>><strong><%= number_to_currency( total_material_budget, unit: "", :precision => 2) %></strong></td>
          <td class="currency"><strong><%= number_to_currency( total_spent_material_budget, unit: "", :precision => 2) %></strong></td>
          <td class="currency" <% if (total_material_budget - total_spent_material_budget)!=0 %>bgcolor="orange"<% end %>><strong><%= number_to_currency( total_material_budget - total_spent_material_budget, unit: "", :precision => 2) %></strong></td>
          <td class="currency"><strong><%= number_to_currency( total_planned_budget, unit: "", :precision => 2) %></strong></td>
          <td class="currency"><strong><%= number_to_currency( total_spent_planned_budget, unit: "", :precision => 2) %></strong></td>
          <td class="currency" <% if (total_planned_budget - total_spent_material_budget)<0 %>bgcolor="orange"<% end %>><strong><%= number_to_currency( total_planned_budget - total_spent_planned_budget, unit: "", :precision => 2) %></strong></td>
          <td class="currency"><strong><%= number_to_currency( total_balance, unit: "", :precision => 2) %></strong></td>
          <td class="currency" <% if (total_balance/total_budget)< 0.1 %>bgcolor="orange"<% end %>><strong><%= number_to_percentage(total_balance/total_budget*100, :precision => 2) %></strong></td>
          <td />
        <tr>
        <tr>
            <td></td>
            <td>Gauto biudžeto suma</td>
            <td class="currency"><strong><%= number_to_currency( total_budget, unit: "", :precision => 2) %></strong></td>
        </tr>
        <% end %>
      </tbody>
    </table>
    * Visos pateiktos sumos yra eurais
    <div class="generic-table--header-background"></div>
  </div>  
</div>

<% end -%>
